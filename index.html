<!DOCTYPE html>
<html lang="ja">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"">
    <title>PokeRunGame</title>
    <style>
        body {
            overflow: hidden;
        }

        #player {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: rgba(225, 225, 225, 0.5);
            bottom: 0;
            /* 初期位置を画面下部に設定 */
        }

        .obstacle {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: rgba(225, 225, 225, 0.5);
            top: -50px;
            z-index: -1;
            /* ボタンよりも下に配置 */
        }

        .container {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
            /* 障害物よりも上に配置 */
        }
    </style>
</head>

<body oncontextmenu=" return false;">
    <img id="player" src="" alt="Player">
    <div id="score">Score: 0</div>
    <div class="container">
        <button id="startButton" onclick="startGame();">Start</button>
        <button id="resetButton" onclick="window.location.reload();">Reset</button>
    </div>

    <script>
        var playerX = 100;
        var playerY = window.innerHeight - 50; // 初期位置を画面下部に設定
        var score = 0;
        var gameRunning = false;
        var gameInterval;
        var obstacles = [];
        var obstacleSpeed = 10; // 障害物の速度を設定
        var maxObstacles = 5; // 最大障害物数を設定
        var obstacleMinDelay = 5000; // 障害物が出現する最小遅延時間（ミリ秒）
        var obstacleMaxDelay = 10000; // 障害物が出現する最大遅延時間（ミリ秒）
        var obstacleMinRate = 0.1; // 障害物の最小サイズ
        var obstacleMaxRate = 0.3; // 障害物の最大サイズ
        // タッチイベントの処理
        var touchStartX = 0;
        var touchStartY = 0;
        var screenWidth = window.innerWidth;
        var screenHeight = window.innerHeight;



        function handleTouchMove(event) {
            event.preventDefault(); // デフォルトのスクロール動作を無効化

            if (gameRunning) {
                var touch = event.touches[0];
                playerX = touch.clientX - 25; // 移動先のX座標を取得
                playerY = touch.clientY - 25; // 移動先のY座標を取得
                updatePlayerPosition(); // プレイヤーの位置を更新
                checkCollision();
            }
        }

        function updatePlayerPosition() {
            var playerElement = document.getElementById('player');
            // プレイヤーのX座標を制限
            if (playerX < 0) {
                playerX = 0;
            } else if (playerX > window.innerWidth - 50) {
                playerX = window.innerWidth - 50;
            }

            // プレイヤーのY座標を制限
            if (playerY < 0) {
                playerY = 0;
            } else if (playerY > window.innerHeight - 50) {
                playerY = window.innerHeight - 50;
            }
            playerElement.style.transform = 'translate(' + playerX + 'px, ' + playerY + 'px)';
        }

        function createObstacle() {
            if (obstacles.length >= maxObstacles) {
                return; // 最大障害物数に達した場合は新たな障害物を生成しない
            }
            var obstacle = document.createElement("img");
            obstacle.className = "obstacle";

            var obstacleX = Math.floor(Math.random() * (window.innerWidth - 50));
            var obstacleY = -50; // 初期位置を画面上部に設定

            obstacle.style.left = obstacleX + "px";
            obstacle.style.top = obstacleY + "px";

            var screenWidth = window.innerWidth;
            var minObstacleSize = screenWidth * obstacleMinRate;
            var maxObstacleSize = screenWidth * obstacleMaxRate;
            var obstacleSize = Math.floor(Math.random() * (maxObstacleSize - minObstacleSize + 1)) + minObstacleSize;
            obstacle.style.width = obstacleSize + "px";
            obstacle.style.height = obstacleSize + "px";

            // ランダムな画像のURLを選択
            obstacle.src = getRandomImageURL();

            document.body.appendChild(obstacle);
            obstacles.push(obstacle);

            var delay = Math.random() * (obstacleMaxDelay - obstacleMinDelay) + obstacleMinDelay;
            setTimeout(createObstacle, delay); // 次の障害物を生成するためのタイマーをセット
        }

        function getRandomImageURL() {
            // ランダムな画像のURLを返す関数
            var numDex = 1010;
            var numRandom = Math.floor(Math.random() * numDex);
            var imageURL = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/" + numRandom + ".png";


            return imageURL;
        }

        function checkCollision() {
            var player = document.getElementById("player");
            var playerRect = player.getBoundingClientRect();

            for (var i = 0; i < obstacles.length; i++) {
                var obstacle = obstacles[i];
                var obstacleRect = obstacle.getBoundingClientRect();

                if (playerRect.left < obstacleRect.right &&
                    playerRect.right > obstacleRect.left &&
                    playerRect.top < obstacleRect.bottom &&
                    playerRect.bottom > obstacleRect.top) {
                    if (gameRunning) { // ゲームが実行中である場合のみゲームオーバーとする
                        gameOver();
                    }
                    break;
                }
            }
        }

        function increaseScore() {
            score++;
            document.getElementById("score").textContent = "Score: " + (score / maxObstacles);
        }

        function gameLoop() {
            createObstacle();

            var obstacles = document.getElementsByClassName("obstacle");
            var playerRect = player.getBoundingClientRect();
            for (var i = 0; i < obstacles.length; i++) {
                var obstacle = obstacles[i];
                var obstacleY = parseInt(obstacle.style.top);
                var obstacleRect = obstacle.getBoundingClientRect();

                obstacleY += obstacleSpeed; // 障害物の速度を適用
                obstacle.style.top = obstacleY + "px";
                if (obstacleY > window.innerHeight) {
                    resetObstacle(obstacle); // 障害物を再配置する
                    obstacle.parentNode.removeChild(obstacle); // 障害物を削除する
                    i--; // 配列の要素が1つ削除されたので、インデックスを調整する
                }
                // プレイヤーと障害物の衝突判定
                if (
                    playerRect.left < obstacleRect.right &&
                    playerRect.right > obstacleRect.left &&
                    playerRect.top < obstacleRect.bottom &&
                    playerRect.bottom > obstacleRect.top
                ) {
                    gameOver(); // 衝突した場合はゲームオーバー
                    return; // ゲームオーバー時にループを終了する
                }
            }

            if (gameRunning) {
                gameInterval = requestAnimationFrame(gameLoop);
            }
        }

        function resetObstacle(obstacle) {
            var index = obstacles.indexOf(obstacle);
            if (index > -1) {
                obstacles.splice(index, 1); // 配列から障害物を削除する
            }
            var obstacleX = Math.floor(Math.random() * (window.innerWidth - obstacle.offsetWidth));
            var obstacleY = -obstacle.offsetHeight;

            obstacle.style.left = obstacleX + "px";
            obstacle.style.top = obstacleY + "px";

            increaseScore();
        }

        function startGame() {
            if (!gameRunning) {
                document.getElementById("player").style.display = "block";
                gameRunning = true;
                score = 0;
                // タッチイベントを登録
                document.addEventListener("touchmove", handleTouchMove);

                document.getElementById("score").textContent = "Score: " + score;
                document.getElementById("startButton").disabled = true;
                document.getElementById("resetButton").disabled = true;
                // Startボタンを非表示にする
                document.getElementById("startButton").style.display = "none";
                document.getElementById("resetButton").style.display = "none";
                // ランダムなプレイヤー画像URLを取得して設定
                var playerImageURL = getRandomPlayerImageURL();
                document.getElementById("player").src = playerImageURL;

                gameLoop();
            }
        }

        function getRandomPlayerImageURL() {
            var numImages = 1010; // プレイヤー画像の枚数
            var randomIndex = Math.floor(Math.random() * numImages) + 1; // 1から枚数までのランダムな数を生成
            var imageURL = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/back/" + randomIndex + ".png"; // 画像ファイルのパスを生成

            return imageURL;
        }

        function gameOver() {
            gameRunning = false;
            gameInterval = null; // ゲームループのインターバルをリセット
            cancelAnimationFrame(gameInterval);
            document.getElementById("resetButton").disabled = false;
            document.getElementById("startButton").style.display = "block";
            document.getElementById("resetButton").style.display = "block";

            alert("Game Over!");
        }



        document.getElementById("player").style.display = "none";

        document.addEventListener('touchstart', function (event) {
            touchStartX = event.touches[0].clientX;
            touchStartY = event.touches[0].clientY;
        });

        document.addEventListener('touchmove', function (event) {
            event.preventDefault(); // デフォルトのスクロール動作を禁止

            var touchMoveX = event.touches[0].clientX;
            var touchMoveY = event.touches[0].clientY;

            // 移動量の計算
            var deltaX = touchMoveX - touchStartX;
            var deltaY = touchMoveY - touchStartY;

            // プレイヤーの新しい位置
            playerX += deltaX;
            playerY += deltaY;

            // プレイヤー位置の更新
            updatePlayerPosition();

            // タッチ開始位置の更新
            touchStartX = touchMoveX;
            touchStartY = touchMoveY;
        });
    </script>
    </body>

</html>